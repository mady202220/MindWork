<!DOCTYPE html>
<html>
<head>
    <title>Enriched Jobs - MindWork</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/brand.css">
    <style>

        
        .job-card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--gray-200);
            margin-bottom: var(--space-6);
            overflow: hidden;
            transition: all 0.2s ease;
        }
        
        .job-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        
        .job-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--gray-200);
            background: linear-gradient(135deg, var(--gray-50) 0%, white 100%);
        }
        
        .job-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            margin: 0 0 var(--space-2) 0;
            line-height: 1.4;
        }
        
        .job-meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-4);
            color: var(--gray-600);
            font-size: 0.875rem;
        }
        
        .job-meta-item {
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }
        
        .enriched-section {
            padding: var(--space-6);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gray-900);
            margin: 0 0 var(--space-4) 0;
        }
        
        .contact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-4);
            margin: var(--space-4) 0;
        }
        
        .contact-item {
            background: var(--gray-50);
            padding: var(--space-4);
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-200);
            transition: all 0.2s ease;
        }
        
        .contact-item:hover {
            background: white;
            box-shadow: var(--shadow-sm);
        }
        
        .contact-label {
            display: block;
            margin-bottom: var(--space-2);
            color: var(--gray-700);
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .contact-input {
            width: 100%;
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        
        .contact-input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px var(--primary-blue-light);
        }
        
        .action-buttons {
            padding: var(--space-4) var(--space-6);
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }
        
        .outreach-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            margin-right: auto;
        }
        
        .btn-whatsapp {
            background: #25D366;
            color: white;
        }
        
        .btn-whatsapp:hover {
            background: #128C7E;
        }
        
        .btn-linkedin {
            background: #0077B5;
            color: white;
        }
        
        .btn-linkedin:hover {
            background: #005885;
        }
        
        .btn-email {
            background: #EA4335;
            color: white;
        }
        
        .btn-email:hover {
            background: #C23321;
        }
        
        .job-description {
            padding: var(--space-4) var(--space-6);
            color: var(--gray-700);
            line-height: 1.6;
            border-top: 1px solid var(--gray-200);
            background: var(--gray-50);
        }
        
        .empty-state {
            text-align: center;
            padding: var(--space-12);
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
        }
        
        .empty-icon {
            font-size: 4rem;
            margin-bottom: var(--space-4);
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚úÖ Enriched Jobs</h1>
        <p>Jobs with complete client contact information ready for outreach</p>
    </div>

    <div class="nav-tabs">
        <a href="/" class="nav-tab">Dashboard</a>
        <a href="/enriched-jobs" class="nav-tab active">‚úÖ Enriched Jobs</a>
        <a href="/team-management" class="nav-tab">üë• Team</a>
        <a href="/admin" class="nav-tab admin-tab">‚öôÔ∏è Admin</a>
        <a href="/logout" class="nav-tab" style="margin-left: auto; background: #e74c3c; color: white;">üö™ Logout</a>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <h3 class="stat-number">{{ jobs|length }}</h3>
                <p class="stat-label">Enriched Jobs</p>
            </div>
            <div class="stat-card">
                <h3 class="stat-number" id="pending-count">0</h3>
                <p class="stat-label">Pending Outreach</p>
            </div>
            <div class="stat-card">
                <h3 class="stat-number" id="sent-count">0</h3>
                <p class="stat-label">Outreach Sent</p>
            </div>
        </div>
        
        <div class="search-box">
            <input type="text" id="searchInput" class="search-input" 
                   placeholder="üîç Search jobs by title, company, or client name..." 
                   onkeyup="searchJobs()">
        </div>

        {% if jobs|length == 0 %}
        <div class="empty-state">
            <div class="empty-icon">üìã</div>
            <h3>No enriched jobs yet</h3>
            <p class="text-gray-600">Jobs will appear here after you enrich client contact information from the RSS feeds.</p>
            <a href="/" class="btn btn-primary mt-4">Go to Dashboard</a>
        </div>
        {% endif %}

        {% for job in jobs %}
        <div class="job-card">
            <div class="job-header">
                <h3 class="job-title">{{ job[1] }}</h3>
                <div class="job-meta">
                    <div class="job-meta-item">
                        <span>üìÖ</span>
                        <span>{{ job[6][:10] }}</span>
                    </div>
                    <div class="job-meta-item">
                        <span>üí∞</span>
                        <span>{{ job[5] }}</span>
                    </div>
                    <div class="job-meta-item">
                        <span class="badge badge-{{ 'success' if job[24] == 'Sent' else 'warning' }}">{{ job[24] or 'Pending' }}</span>
                    </div>
                </div>
            </div>
            
            <div class="enriched-section">
                <h4 class="section-title">
                    <span>üìû</span>
                    <span>Contact Information</span>
                </h4>
                <div class="contact-grid">
                    <div class="contact-item">
                        <label class="contact-label">üë§ Contact Name</label>
                        <input type="text" id="name-{{ job[0] }}" value="{{ job[10] or '' }}" class="contact-input">
                    </div>
                    <div class="contact-item">
                        <label class="contact-label">üè¢ Company</label>
                        <input type="text" id="company-{{ job[0] }}" value="{{ job[11] or '' }}" class="contact-input">
                    </div>
                    <div class="contact-item">
                        <label class="contact-label">üåÜ City</label>
                        <input type="text" id="city-{{ job[0] }}" value="{{ job[12] or '' }}" class="contact-input">
                    </div>
                    <div class="contact-item">
                        <label class="contact-label">üåç Country</label>
                        <input type="text" id="country-{{ job[0] }}" value="{{ job[13] or '' }}" class="contact-input">
                    </div>
                    <div class="contact-item">
                        <label class="contact-label">üîó LinkedIn</label>
                        <input type="text" id="linkedin-{{ job[0] }}" value="{{ job[14] or '' }}" class="contact-input">
                    </div>
                    <div class="contact-item">
                        <label class="contact-label">‚úâÔ∏è Email</label>
                        <input type="text" id="email-{{ job[0] }}" value="{{ job[15] or '' }}" class="contact-input">
                    </div>
                    <div class="contact-item">
                        <label class="contact-label">üìû Phone</label>
                        <input type="text" id="phone-{{ job[0] }}" value="{{ job[16] or '' }}" class="contact-input">
                    </div>
                    <div class="contact-item">
                        <label class="contact-label">üì± WhatsApp</label>
                        <input type="text" id="whatsapp-{{ job[0] }}" value="{{ job[17] or '' }}" class="contact-input">
                    </div>
                    <div class="contact-item">
                        <label class="contact-label">üéØ Decision Maker</label>
                        <input type="text" id="decision-{{ job[0] }}" value="{{ job[19] or '' }}" class="contact-input">
                    </div>
                    <div class="contact-item">
                        <label class="contact-label">üì§ Outreach Status</label>
                        <select id="outreach-status-{{ job[0] }}" class="contact-input">
                            <option value="Pending" {% if not job[24] or job[24] == 'Pending' %}selected{% endif %}>Pending</option>
                            <option value="Sent" {% if job[24] == 'Sent' %}selected{% endif %}>Sent</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="saveEnrichment('{{ job[0] }}')">Save Changes</button>
                

            </div>
            
            <div style="margin-top: 15px;">
                <strong>Description:</strong> {{ job[2][:200] }}...
            </div>
            
            <div style="margin-top: 15px;">
                <a href="{{ job[3] }}" target="_blank" class="btn btn-primary">View Job</a>
                <button class="btn btn-success" onclick="generateProposal('{{ job[0] }}')">Generate Proposal</button>
                <button class="btn" style="background: #25D366; color: white;" onclick="openWhatsAppModal('{{ job[0] }}', '{{ job[1] }}', '{{ job[2][:200] }}')">üì± Generate WA</button>
                <button class="btn" style="background: #0077B5; color: white;" onclick="openLinkedInModal('{{ job[0] }}', '{{ job[1] }}', '{{ job[2][:200] }}')">üíº Generate LinkedIn</button>
                <button class="btn" style="background: #EA4335; color: white;" onclick="openEmailModal('{{ job[0] }}', '{{ job[1] }}', '{{ job[2][:200] }}')">üìß Generate Email</button>
                <button class="btn" style="background: #e74c3c; color: white;" onclick="deleteJob('{{ job[0] }}')">üóëÔ∏è Delete</button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- WhatsApp Modal -->
    <div id="whatsappModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3>üì± Generate WhatsApp Message</h3>
            <div class="form-group">
                <label>Prompt:</label>
                <textarea id="waPrompt" style="width: 100%; height: 80px;">Generate WhatsApp message for this client after considering job title and job description.</textarea>
            </div>
            <button class="btn btn-success" onclick="generateWhatsApp()">Generate Message</button>
            <button class="btn" style="background: #666; color: white; margin-left: 10px;" onclick="closeModal('whatsappModal')">Close</button>
            <div id="waResult" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; display: none;"></div>
        </div>
    </div>

    <!-- LinkedIn Modal -->
    <div id="linkedinModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3>üíº Generate LinkedIn Message</h3>
            <div class="form-group">
                <label>Prompt:</label>
                <textarea id="liPrompt" style="width: 100%; height: 80px;">Generate LinkedIn message for this client after considering job title and job description.</textarea>
            </div>
            <button class="btn btn-success" onclick="generateLinkedIn()">Generate Message</button>
            <button class="btn" style="background: #666; color: white; margin-left: 10px;" onclick="closeModal('linkedinModal')">Close</button>
            <div id="liResult" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; display: none;"></div>
        </div>
    </div>

    <!-- Email Modal -->
    <div id="emailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 8px; width: 600px; max-height: 80vh; overflow-y: auto;">
            <h3>üìß Generate Email</h3>
            <div class="form-group">
                <label>Prompt:</label>
                <textarea id="emailPrompt" style="width: 100%; height: 60px;">Generate professional email for this client after considering job title and job description.</textarea>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>Subject:</label>
                    <input type="text" id="emailSubject" style="width: 100%;" placeholder="Email subject">
                </div>
                <div class="form-group">
                    <label>Follow-up Subject:</label>
                    <input type="text" id="followupSubject" style="width: 100%;" placeholder="Follow-up subject">
                </div>
            </div>
            <button class="btn btn-success" onclick="generateEmail()">Generate Email</button>
            <button class="btn" style="background: #666; color: white; margin-left: 10px;" onclick="closeModal('emailModal')">Close</button>
            <div id="emailResult" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        function generateProposal(jobId) {
            // Redirect to RSS page for proposal generation
            window.location.href = `/rss/1?job=${jobId}`;
        }
        
        function saveEnrichment(jobId) {
            const data = {
                job_id: jobId,
                client_name: document.getElementById(`name-${jobId}`).value,
                client_company: document.getElementById(`company-${jobId}`).value,
                client_city: document.getElementById(`city-${jobId}`).value,
                client_country: document.getElementById(`country-${jobId}`).value,
                linkedin_url: document.getElementById(`linkedin-${jobId}`).value,
                email: document.getElementById(`email-${jobId}`).value,
                phone: document.getElementById(`phone-${jobId}`).value,
                whatsapp: document.getElementById(`whatsapp-${jobId}`).value,
                decision_maker: document.getElementById(`decision-${jobId}`).value,
                outreach_status: document.getElementById(`outreach-status-${jobId}`).value
            };
            
            fetch('/update_enrichment', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Enrichment data updated successfully!');
                } else {
                    alert('Failed to update enrichment data');
                }
            })
            .catch(error => {
                alert('Error updating enrichment data: ' + error);
            });
        }
        
        function deleteJob(jobId) {
            if (confirm('Are you sure you want to delete this job? This action cannot be undone.')) {
                fetch(`/delete_job/${jobId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error deleting job: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error deleting job: ' + error);
                });
            }
        }
        
        function searchJobs() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const jobCards = document.querySelectorAll('.job-card');
            
            jobCards.forEach(card => {
                const title = card.querySelector('.job-title').textContent.toLowerCase();
                const nameInput = card.querySelector('input[id*="name-"]');
                const companyInput = card.querySelector('input[id*="company-"]');
                const name = nameInput ? nameInput.value.toLowerCase() : '';
                const company = companyInput ? companyInput.value.toLowerCase() : '';
                
                if (title.includes(searchTerm) || name.includes(searchTerm) || company.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        let currentJobData = {};
        
        function openWhatsAppModal(jobId, jobTitle, jobDescription) {
            currentJobData = {id: jobId, title: jobTitle, description: jobDescription};
            document.getElementById('whatsappModal').style.display = 'block';
        }
        
        function openLinkedInModal(jobId, jobTitle, jobDescription) {
            currentJobData = {id: jobId, title: jobTitle, description: jobDescription};
            document.getElementById('linkedinModal').style.display = 'block';
        }
        
        function openEmailModal(jobId, jobTitle, jobDescription) {
            currentJobData = {id: jobId, title: jobTitle, description: jobDescription};
            document.getElementById('emailModal').style.display = 'block';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function generateWhatsApp() {
            const prompt = document.getElementById('waPrompt').value;
            const resultDiv = document.getElementById('waResult');
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="text-align: center;">üîÑ Generating WhatsApp message...</div>';
            
            fetch('/generate_outreach', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    type: 'whatsapp',
                    prompt: prompt,
                    job_title: currentJobData.title,
                    job_description: currentJobData.description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `<h4>WhatsApp Message:</h4><div style="background: white; padding: 15px; border: 1px solid #ddd; border-radius: 4px; white-space: pre-wrap;">${data.message}</div>`;
                } else {
                    resultDiv.innerHTML = `<div style="color: red;">Error: ${data.error}</div>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<div style="color: red;">Error: ${error}</div>`;
            });
        }
        
        function generateLinkedIn() {
            const prompt = document.getElementById('liPrompt').value;
            const resultDiv = document.getElementById('liResult');
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="text-align: center;">üîÑ Generating LinkedIn message...</div>';
            
            fetch('/generate_outreach', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    type: 'linkedin',
                    prompt: prompt,
                    job_title: currentJobData.title,
                    job_description: currentJobData.description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `<h4>LinkedIn Message:</h4><div style="background: white; padding: 15px; border: 1px solid #ddd; border-radius: 4px; white-space: pre-wrap;">${data.message}</div>`;
                } else {
                    resultDiv.innerHTML = `<div style="color: red;">Error: ${data.error}</div>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<div style="color: red;">Error: ${error}</div>`;
            });
        }
        
        function generateEmail() {
            const prompt = document.getElementById('emailPrompt').value;
            const subject = document.getElementById('emailSubject').value;
            const followupSubject = document.getElementById('followupSubject').value;
            const resultDiv = document.getElementById('emailResult');
            
            resultDiv.innerHTML = '<div style="text-align: center;">üîÑ Generating emails...</div>';
            
            fetch('/generate_outreach', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    type: 'email',
                    prompt: prompt,
                    subject: subject,
                    followup_subject: followupSubject,
                    job_title: currentJobData.title,
                    job_description: currentJobData.description
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `
                        <h4>Initial Email:</h4>
                        <div style="background: white; padding: 15px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px;">
                            <strong>Subject:</strong> ${data.subject}<br><br>
                            <div style="white-space: pre-wrap;">${data.body}</div>
                        </div>
                        <h4>Follow-up Email:</h4>
                        <div style="background: white; padding: 15px; border: 1px solid #ddd; border-radius: 4px;">
                            <strong>Subject:</strong> ${data.followup_subject}<br><br>
                            <div style="white-space: pre-wrap;">${data.followup_body}</div>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div style="color: red;">Error: ${data.error}</div>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<div style="color: red;">Error: ${error}</div>`;
            });
        }
        
        // Initialize stats
        updateOutreachStats();
        
        function updateOutreachStats() {
            let pendingCount = 0;
            let sentCount = 0;
            
            document.querySelectorAll('select[id*="outreach-status-"]').forEach(select => {
                if (select.value === 'Sent') {
                    sentCount++;
                } else {
                    pendingCount++;
                }
            });
            
            document.getElementById('pending-count').textContent = pendingCount;
            document.getElementById('sent-count').textContent = sentCount;
        }
    </script>
</body>
</html>