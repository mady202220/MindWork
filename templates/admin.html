<!DOCTYPE html>
<html>
<head>
    <title>Admin - RSS & Prompts Management</title>
    <link rel="stylesheet" href="/static/css/brand.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; position: relative; }
        body::before { content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="%23ffffff" opacity="0.05"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat; pointer-events: none; z-index: -1; }
        .header { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); color: white; padding: 25px; border-bottom: 1px solid rgba(255, 255, 255, 0.2); }
        .header h1 { font-size: 2.2rem; font-weight: 800; margin-bottom: 0.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .header p { opacity: 0.9; font-size: 1.1rem; font-weight: 400; }
        .nav-tabs { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 0; margin: 0; display: flex; border-bottom: 1px solid rgba(255, 255, 255, 0.1); flex-wrap: wrap; }
        .nav-tab { padding: 15px 20px; color: rgba(255, 255, 255, 0.8); text-decoration: none; border-right: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; font-weight: 500; position: relative; }
        .nav-tab:hover { background: rgba(255, 255, 255, 0.1); color: white; transform: translateY(-2px); }
        .nav-tab.active { background: rgba(255, 255, 255, 0.2); color: white; font-weight: 600; }
        .admin-tab { margin-left: auto; background: rgba(231, 76, 60, 0.8); }
        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .admin-section { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 30px; margin: 20px 0; border-radius: 20px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); }
        .feed-card { background: var(--gray-50); padding: var(--space-6); margin: var(--space-4) 0; border-radius: var(--radius-lg); border-left: 4px solid var(--primary-blue); }
        .feed-name { font-size: 1.25rem; font-weight: 600; margin-bottom: var(--space-2); color: var(--gray-900); }
        .feed-url { color: var(--gray-600); font-size: 0.875rem; margin-bottom: var(--space-4); word-break: break-all; }
        .status-toggle { display: inline-block; padding: var(--space-2) var(--space-4); border-radius: var(--radius-xl); font-size: 0.875rem; cursor: pointer; font-weight: 500; }
        .status-active { background: var(--success-green-light); color: var(--success-green); }
        .status-paused { background: var(--danger-red-light); color: var(--danger-red); }
        .prompt-section { margin: var(--space-6) 0; padding: var(--space-4); background: var(--warning-orange-light); border-radius: var(--radius-md); }
        .prompt-title { font-weight: 600; margin-bottom: var(--space-3); color: var(--warning-orange); }
        .add-rss-form { background: var(--gray-50); padding: var(--space-8); border-radius: var(--radius-lg); margin-bottom: var(--space-6); border: 1px solid var(--gray-200); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-6); }
        .form-grid .full-width { grid-column: 1 / -1; }
        .form-input { width: 100%; padding: var(--space-3); border: 2px solid var(--gray-200); border-radius: var(--radius-md); font-size: 0.875rem; transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 3px var(--primary-blue-light); }
        .form-textarea { width: 100%; padding: var(--space-3); border: 2px solid var(--gray-200); border-radius: var(--radius-md); font-size: 0.875rem; min-height: 120px; font-family: var(--font-mono); transition: all 0.2s; resize: vertical; }
        .form-textarea:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 3px var(--primary-blue-light); }
        .form-label { display: block; margin-bottom: var(--space-2); font-weight: 600; color: var(--gray-700); font-size: 0.875rem; }
        .section-title { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); margin-bottom: var(--space-6); display: flex; align-items: center; gap: var(--space-2); }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚öôÔ∏è Admin Panel</h1>
        <p>Manage RSS feeds and customize prompts</p>
    </div>

    <div class="nav-tabs">
        <a href="/" class="nav-tab">Dashboard</a>
        <a href="/rss/1" class="nav-tab">Web Development</a>
        <a href="/rss/2" class="nav-tab">Manual Jobs</a>
        <a href="/enriched-jobs" class="nav-tab">‚úÖ Enriched</a>
        <a href="/sent-jobs" class="nav-tab">üì§ Sent</a>
        <a href="/kanban" class="nav-tab">üìã Kanban</a>
        <a href="/team-management" class="nav-tab">üë• Team</a>
        <a href="/admin" class="nav-tab admin-tab active">‚öôÔ∏è</a>
        <a href="/logout" class="nav-tab" style="background: #e74c3c; margin-left: 10px;">üö™</a>
    </div>

    <div class="container">
        <!-- Database Maintenance -->
        <div class="admin-section">
            <h2 class="section-title">
                <span>üîß</span>
                <span>Database Maintenance</span>
            </h2>
            <div style="background: var(--warning-orange-light); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-4);">
                <p style="margin-bottom: var(--space-3); color: var(--gray-700);">
                    If you're experiencing errors with status updates, click the button below to add missing database columns.
                </p>
                <button class="btn btn-warning" onclick="fixMissingColumns()">üîß Fix Missing Columns</button>
                <button class="btn btn-primary" onclick="fixNullStatuses()" style="margin-left: 10px;">üîÑ Fix NULL Status Values</button>
                <div id="fix-result" style="margin-top: var(--space-3); display: none;"></div>
            </div>
        </div>
        
        <!-- Add New RSS Feed -->
        <div class="admin-section">
            <h2 class="section-title">
                <span>‚ûï</span>
                <span>Add New RSS Feed</span>
            </h2>
            <div class="add-rss-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">üì° Feed Name</label>
                        <input type="text" id="new-feed-name" class="form-input" placeholder="e.g., Mobile Development Jobs">
                    </div>
                    <div class="form-group">
                        <label class="form-label">üîó RSS URL</label>
                        <input type="url" id="new-feed-url" class="form-input" placeholder="https://www.vollna.com/rss/...">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">üîç Keyword Extraction Prompt</label>
                        <textarea id="new-keyword-prompt" class="form-textarea" placeholder="Prompt for extracting keywords from job descriptions...">Extract 2 non-technical, functionality-based keywords from this job description for app searching.
Focus on industry/category and main function (e.g., "healthcare booking", "food delivery").
If too technical, use generic categories.

Job: {job_description}

Return only 2 keywords separated by comma:</textarea>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">üìù Proposal Generation Prompt</label>
                        <textarea id="new-proposal-prompt" class="form-textarea" placeholder="Prompt for generating proposals...">Generate a Proposalgenie-format proposal for this job:

Job Title: {job_title}
Job Description: {job_description}

Work Examples: {examples_text}

Follow the exact format:
- Start with: {greeting}
- Short intro with role + years + specialization
- Paragraph 1: technical fit + expected result
- Paragraph 2: Work examples (use the provided examples)
- Paragraph 3: exactly 2 thoughtful developer/designer questions
- Paragraph 4: CTA with call availability

Use Unicode formatting, no markdown. Be conversational but professional.</textarea>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">üîç Olostep Enrichment Prompt</label>
                        <textarea id="new-olostep-prompt" class="form-textarea" placeholder="Prompt for client enrichment...">Find contact info for {search_target} in {city}, {country}. Get LinkedIn, email, phone, WhatsApp.</textarea>
                    </div>
                </div>
                <div style="margin-top: var(--space-6); text-align: center;">
                    <button class="btn btn-success btn-lg" onclick="addRSSFeed()">‚úÖ Add RSS Feed</button>
                </div>
            </div>
        </div>

        <!-- Existing RSS Feeds -->
        <div class="admin-section">
            <h2 class="section-title">
                <span>üì°</span>
                <span>Manage RSS Feeds</span>
            </h2>
            
            {% for feed in feeds %}
            <div class="feed-card" id="feed-{{ feed[0] }}">
                <div class="feed-name">{{ feed[1] }}</div>
                <div class="feed-url">{{ feed[2] }}</div>
                
                <div style="margin: 15px 0;">
                    <span class="status-toggle {% if feed[3] == 1 %}status-active{% else %}status-paused{% endif %}" 
                          onclick="toggleRSSStatus({{ feed[0] }})">
                        {% if feed[3] == 1 %}üü¢ Active{% else %}‚è∏Ô∏è Paused{% endif %}
                    </span>
                </div>

                <!-- Prompts Section -->
                <div class="prompt-section">
                    <div class="prompt-title">üîß Custom Prompts</div>
                    
                    <div class="form-group">
                        <label>Keyword Extraction Prompt:</label>
                        <textarea id="keyword-prompt-{{ feed[0] }}">{{ feed[4] or '' }}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Proposal Generation Prompt:</label>
                        <textarea id="proposal-prompt-{{ feed[0] }}">{{ feed[5] or '' }}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Olostep Enrichment Prompt:</label>
                        <textarea id="olostep-prompt-{{ feed[0] }}">{{ feed[6] or '' }}</textarea>
                    </div>
                    
                    <button class="btn btn-primary" onclick="updatePrompts({{ feed[0] }})">üíæ Save Prompts</button>
                    <button class="btn btn-warning" onclick="resetPrompts({{ feed[0] }})">üîÑ Reset to Default</button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        function fixMissingColumns() {
            const resultDiv = document.getElementById('fix-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="color: var(--primary-blue);">üîÑ Checking and adding missing columns...</div>';
            
            fetch('/add-status-columns', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="color: var(--success-green); padding: var(--space-3); background: var(--success-green-light); border-radius: var(--radius-sm);">
                            ‚úÖ ${data.message}<br>
                            <small>Added: ${data.added.join(', ') || 'none'}</small><br>
                            <small>Already existed: ${data.existing.join(', ') || 'none'}</small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div style="color: var(--danger-red);">‚ùå Error: ${data.error}</div>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<div style="color: var(--danger-red);">‚ùå Error: ${error}</div>`;
            });
        }
        
        function fixNullStatuses() {
            const resultDiv = document.getElementById('fix-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="color: var(--primary-blue);">üîÑ Fixing NULL status values...</div>';
            
            fetch('/fix-null-statuses', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="color: var(--success-green); padding: var(--space-3); background: var(--success-green-light); border-radius: var(--radius-sm);">
                            ‚úÖ Fixed ${data.total_fixed} NULL values!<br>
                            <small>Proposal Status: ${data.proposal_status_fixed} rows</small><br>
                            <small>Outreach Status: ${data.outreach_status_fixed} rows</small><br>
                            <small>Submitted By: ${data.submitted_by_fixed} rows</small>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div style="color: var(--danger-red);">‚ùå Error: ${data.error}</div>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<div style="color: var(--danger-red);">‚ùå Error: ${error}</div>`;
            });
        }
        
        function addRSSFeed() {
            const name = document.getElementById('new-feed-name').value;
            const url = document.getElementById('new-feed-url').value;
            const keywordPrompt = document.getElementById('new-keyword-prompt').value;
            const proposalPrompt = document.getElementById('new-proposal-prompt').value;
            const olostepPrompt = document.getElementById('new-olostep-prompt').value;
            
            if (!name || !url || !keywordPrompt || !proposalPrompt || !olostepPrompt) {
                alert('Please fill all fields');
                return;
            }
            
            fetch('/add_rss', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: name,
                    url: url,
                    keyword_prompt: keywordPrompt,
                    proposal_prompt: proposalPrompt,
                    olostep_prompt: olostepPrompt
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('RSS feed added successfully!');
                    location.reload();
                } else {
                    alert('Error adding RSS feed');
                }
            })
            .catch(error => {
                alert('Error: ' + error);
            });
        }
        
        function toggleRSSStatus(rssId) {
            fetch(`/toggle_rss/${rssId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error toggling RSS status');
                }
            });
        }
        
        function updatePrompts(rssId) {
            const keywordPrompt = document.getElementById(`keyword-prompt-${rssId}`).value;
            const proposalPrompt = document.getElementById(`proposal-prompt-${rssId}`).value;
            const olostepPrompt = document.getElementById(`olostep-prompt-${rssId}`).value;
            
            fetch(`/update_prompts/${rssId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    keyword_prompt: keywordPrompt,
                    proposal_prompt: proposalPrompt,
                    olostep_prompt: olostepPrompt
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Prompts updated successfully!');
                } else {
                    alert('Error updating prompts');
                }
            });
        }
        
        function resetPrompts(rssId) {
            if (!confirm('Are you sure you want to reset prompts to default?')) {
                return;
            }
            
            const defaultKeyword = `Extract 2 non-technical, functionality-based keywords from this job description for app searching.
Focus on industry/category and main function (e.g., "healthcare booking", "food delivery").
If too technical, use generic categories.

Job: {job_description}

Return only 2 keywords separated by comma:`;

            const defaultProposal = `Generate a Proposalgenie-format proposal for this job:

Job Title: {job_title}
Job Description: {job_description}

Work Examples: {examples_text}

Follow the exact format:
- Start with: {greeting}
- Short intro with role + years + specialization
- Paragraph 1: technical fit + expected result
- Paragraph 2: Work examples (use the provided examples)
- Paragraph 3: exactly 2 thoughtful developer/designer questions
- Paragraph 4: CTA with call availability

Use Unicode formatting, no markdown. Be conversational but professional.`;

            const defaultOlostep = `Find contact info for {search_target} in {city}, {country}. Get LinkedIn, email, phone, WhatsApp.`;
            
            document.getElementById(`keyword-prompt-${rssId}`).value = defaultKeyword;
            document.getElementById(`proposal-prompt-${rssId}`).value = defaultProposal;
            document.getElementById(`olostep-prompt-${rssId}`).value = defaultOlostep;
            
            updatePrompts(rssId);
        }
    </script>
</body>
</html>